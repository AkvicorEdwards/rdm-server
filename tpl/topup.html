<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>充值</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        .divf {
            width: 200px;
            height: 100px;
            background: transparent;
            float: contour;
        }

        .main {
            text-align: center; /*让div内部文字居中*/
            background-color: #fff;
            /*width: 75%;*/
            /*height: 350px;*/
            margin-left: 2%;
            /*margin-right: 2%;*/
            margin-top: 2%;
            position: relative;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .td {
            font-family: sans-serif;
            text-align: center;
            padding-left: 20px;
            padding-right: 20px;
        }

        .bd {
            border-collapse: collapse;
            border: 1px solid black;
            border-spacing: 1px;
        }
    </style>
    <style>
        .black_overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 1001;
            -moz-opacity: 0.8;
            opacity: .80;
            filter: alpha(opacity=88);
        }

        .white_content {
            display: none;
            position: absolute;
            top: 25%;
            left: 25%;
            width: 55%;
            height: 55%;
            padding: 20px;
            /*border: 10px solid orange;*/
            background-color: white;
            z-index: 1002;
            overflow: auto;
        }
    </style>
    <script>
        function s_open() {
            get("/work_custom", update_list_custom);
            document.getElementById('light').style.display = 'block';
            document.getElementById('fade').style.display = 'block'
        }

        function s_close() {
            document.getElementById('light').style.display = 'none';
            document.getElementById('fade').style.display = 'none'
        }
    </script>
</head>
<body>

<div id="light" class="white_content">
    <table>
        <tr class="bd">
            <td class="td bd" style="background: aquamarine;" onclick="s_close()">确定</td>
        </tr>
    </table>
    <br/>
    <table>
        <tr>
            <td style="vertical-align:top;">
                <table id="forest_work_custom">
                </table>
            </td>
        </tr>
    </table>
</div>

<div id="fade" class="black_overlay"></div>

<table style="margin-left: 2%;margin-top: 2%;position: relative;">
    <tr>
        <td>
            <form>
                <table id="forest_user">
                    <tr class="bd">
                        <td class="td bd" style="background: darkgray">UUID</td>
                        <td class="td bd" style="background: darkgray">用户名</td>
                        <td class="td bd" style="background: darkgray">昵称</td>
                        <td class="td bd" style="background: darkgray">累计充值</td>
                        <td class="td bd" style="background: darkgray">累计提现</td>
                        <td class="td bd" style="background: darkgray">硬币数量</td>
                    </tr>
                    <tr class="bd" id="user_info">
                        <td class="td bd">#</td>
                        <td class="td bd">#</td>
                        <td class="td bd">#</td>
                        <td class="td bd">#</td>
                        <td class="td bd">#</td>
                        <td class="td bd">#</td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr style="height: 24px"></tr>
    <tr>
        <td>
            <table>
                <tr class="bd" onclick="s_open()">
                    <form method="post" id="work_forms">
                        <label>数量：
                            <input type="number" name="quantity" id="quantity" value="" placeholder="数量">
                        </label><br/><br/>
                    </form>
                    <td class="td bd" style="background: darkgray">已选</td>
                    <td class="td bd" id="work_name">#</td>
                </tr>
            </table>
        </td>
    </tr>
    <tr style="height: 24px"></tr>
    <tr>
        <td style="padding-right: 40px; padding-bottom: 20px">
            <table>
                <tr class="bd">
                    <td class="td bd" style="background: azure" onclick="time_start()">确定</td>
                    <td class="td bd" style="background: azure" onclick="location='/'">关闭</td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</body>
<script>
    String.prototype.format = function () {
        let args = Array.prototype.slice.call(arguments);
        let count = 0;
        return this.replace(/%s/g, function () {
            return args[count++];
        });
    }


    /**
     * 0 UUID
     * 1 Username
     * 2 Nickname
     * 3 RMB
     * 4 Coin
     * @type {HTMLCollectionOf<HTMLTableDataCellElement | HTMLTableHeaderCellElement>}
     */
    let user_info = document.getElementById('user_info').cells
    let work_name = document.getElementById('work_name')
    let work_custom = ""
    let work_list_custom = document.getElementById('forest_work_custom')
    let selected_work = ""
    let selected_work_json = ""

    function update_user_info() {
        user_info[0].innerText = getCookie("uuid")
        user_info[1].innerText = getCookie("username")
        user_info[2].innerText = getCookie("nickname")
        user_info[3].innerText = getCookie("rmb_in")
        user_info[4].innerText = getCookie("rmb_out")
        user_info[5].innerText = getCookie("coin")
    }

    // 更新已选择任务
    function update_selected_work() {
        work_name.innerText = selected_work_json.name
    }

    function update_list_custom(str) {
        work_custom = JSON.parse(str);
        let data = JSON.parse(str);
        let html = ``;

        for (let i = 0; i < data.length; ++i) {
            html += `
<tr class="bd" id="%s" onclick="select_work_json(work_custom, '%s');select_work('%s')">
    <td class="td bd">%s</td>
</tr>
`.format(data[i].wuid, i, data[i].wuid, data[i].name);
        }

        work_list_custom.innerHTML = html;
    }

    // 弹出框选择要执行的任务
    function select_work(id) {
        if (selected_work === id) {
            document.getElementById(id).style.background = '';
            selected_work = ""
            return
        }
        if (selected_work !== "") {
            document.getElementById(selected_work).style.background = '';
        }
        document.getElementById(id).style.background = 'red';
        selected_work = id
    }

    // 通过鼠标点击选择更新已选择的任务
    function select_work_json(work, index) {
        selected_work_json = work[index]
        update_selected_work()
    }

    // 计算任务开始时到现在的时间
    function work_timing() {
        work_time.innerText = formatSeconds((new Date().getTime() / 1000) - work_start_time);
    }

    // 选择某个任务后开始计时
    // status:
    //  0  Error
    //  4  充值成功
    function time_start() {
        let url = '/plant?wuid=' + selected_work_json.wuid + '&quantity=' + document.getElementById('quantity').value
        get(url, function (str) {
            let data = JSON.parse(str);
            if (data.status === "0") { // 0  Error
                alert("Error")
            } else if (data.status === "4") { // 4  充值成功
                alert("RmbIn:[%s] RmboUT:[%s] Coin:[%s]".format(data.rmb_in, data.rmb_out, data.coin))
            }
            update_user_info()
        })
    }


</script>

<script>
    /**
     * 发送POST请求
     * @param url 请求URL
     * @param formvalue 需要发送的数据
     * @param func 返回信息处理函数
     */
    function post(url, formvalue, func) {
        let httpRequest = new XMLHttpRequest();
        httpRequest.open('POST', url, true);
        httpRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        httpRequest.send(formvalue);
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState === 4 && httpRequest.status === 200) {
                func(httpRequest.responseText);
            }
        };
    }

    /**
     * 发送GET请求
     * @param url 请求URL
     * @param func 返回信息处理函数
     */
    function get(url, func) {
        let httpRequest = new XMLHttpRequest();
        httpRequest.open('GET', url, true);
        httpRequest.send();
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState === 4 && httpRequest.status === 200) {
                func(httpRequest.responseText);
            }
        };
    }

    /**
     * 获取表单的值，拼接成字符串返回
     * @param formId 表单ID
     * @returns {string} 拼接成字符串的值
     */
    function formValue(formId) {
        const formObj = document.getElementById(formId);
        let name, value, postString = "";
        if (formObj.elements.length) {
            for (let i = 0; i < formObj.length; i++) {
                let singleObj = formObj[i];
                if (singleObj.type !== "reset" && singleObj.type !== "submit"
                    && singleObj.type !== "button") {
                    if (singleObj.type === "radio" || singleObj.type === "checkbox") {
                        if (singleObj.checked) {
                            name = singleObj.name;
                            value = singleObj.value;
                            postString = postString + name + "=" + value + "&";
                        }
                    } else {
                        name = singleObj.name;
                        value = singleObj.value;
                        postString = postString + name + "=" + value + "&";
                    }
                }
            }
        }
        return postString.substr(0, postString.length - 1);
    }

    function setCookie(name, value, seconds) {
        seconds = seconds || 0;   //seconds有值就直接赋值，没有为0，这个根php不一样。
        let expires = "";
        if (seconds !== 0) {      //设置cookie生存时间
            const date = new Date();
            date.setTime(date.getTime() + (seconds * 1000));
            expires = "; expires=" + date.toGMTString();
        }
        document.cookie = name + "=" + escape(value) + expires + "; path=/";   //转码并赋值
    }

    function getCookie(cookie_name) {
        const allcookies = document.cookie;
        let cookie_pos = allcookies.indexOf(cookie_name);
        if (cookie_pos !== -1) {
            cookie_pos += cookie_name.length + 1;
            let cookie_end = allcookies.indexOf(";", cookie_pos);
            if (cookie_end === -1) {
                cookie_end = allcookies.length;
            }
            return unescape(allcookies.substring(cookie_pos, cookie_end));
        }
        return "";
    }

    function deleteCookie(name) {
        //获取当前时间
        const date = new Date();
        //将date设置为过去的时间
        date.setTime(date.getTime() - 10000);
        //将userId这个cookie删除
        //document.cookie="userId=828; expire="+date.toGMTString();
        document.cookie = name + "=v; expires=" + date.toGMTString();
    }

    function isCookie(key) {
        let strCookie = document.cookie;
        strCookie = strCookie.split('; ');
        let i = 0, l = strCookie.length;
        for (; i < l; i++) {
            const att = strCookie[i].split('=');
            if (att[0] === key) {
                return att[1]
            }
        }
        return false
    }

    //清除cookie
    function clearCookie(name) {
        setCookie(name, "", -1);
    }

    // 将秒格式化为 天:时:分:秒
    function formatSeconds(e) {
        let second = parseInt(e);
        let minute = 0;
        let hour = 0;
        let day = 0;
        if (second > 60) {
            minute = parseInt(second / 60);
            second = parseInt(second % 60);
            if (minute > 60) {
                hour = parseInt(minute / 60);
                minute = parseInt(minute % 60);
                if (hour > 24) {
                    day = parseInt(hour / 24);
                    hour = parseInt(hour % 24);
                }
            }
        }
        let interval = "" + parseInt(second) + "s";
        if (minute > 0) {
            interval = "" + parseInt(minute) + "m:" + interval;
        }
        if (hour > 0) {
            interval = "" + parseInt(hour) + "h:" + interval;
        }
        if (day > 0) {
            interval = "" + parseInt(day) + "d:" + interval;
        }
        return interval;
    }
</script>

<script>
    update_user_info()
</script>
</html>